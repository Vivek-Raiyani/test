<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - Finora</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: bold;
            color: #667eea !important;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        .stats-card {
            border-radius: 10px;
        }
        .stats-pending { background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%); color: white; }
        .stats-approved { background: linear-gradient(135deg, #28a745 0%, #34ce57 100%); color: white; }
        .stats-rejected { background: linear-gradient(135deg, #dc3545 0%, #e5535d 100%); color: white; }
        .stats-total { background: linear-gradient(135deg, #007bff 0%, #5a9cf8 100%); color: white; }
        
        .expense-item {
            border-left: 4px solid #007bff;
            transition: background-color 0.2s ease;
        }
        .expense-item:hover {
            background-color: #f8f9ff;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .modal-content {
            border-radius: 10px;
            border: none;
        }
        
        .form-control, .form-select {
            border-radius: 5px;
            border: 1px solid #ced4da;
        }
        
        .priority-high { border-left-color: #dc3545; }
        .priority-medium { border-left-color: #ffc107; }
        .priority-low { border-left-color: #28a745; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="{% url 'core:dashboard' %}">
                <i class="fas fa-chart-line me-2"></i>Finora
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user-tie me-1"></i>{{ user_data.name }} ({{ user_data.role }})
                </span>
                <a class="btn btn-outline-danger btn-sm" href="{% url 'user_app:logout' %}">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-body text-center py-4">
                        <h1 class="card-title mb-3">
                            <i class="fas fa-clipboard-check me-2"></i>Manager Dashboard
                        </h1>
                        <p class="card-text mb-0">Review and approve employee expenses</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card stats-total">
                    <div class="card-body text-center">
                        <h3 class="card-title">{{ total_approvals }}</h3>
                        <p class="card-text mb-0">Total Reviews</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card stats-pending">
                    <div class="card-body text-center">
                        <h3 class="card-title">{{ pending_count }}</h3>
                        <p class="card-text mb-0">Pending Approval</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card stats-approved">
                    <div class="card-body text-center">
                        <h3 class="card-title">{{ approved_count }}</h3>
                        <p class="card-text mb-0">Approved</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card stats-rejected">
                    <div class="card-body text-center">
                        <h3 class="card-title">{{ rejected_count }}</h3>
                        <p class="card-text mb-0">Rejected</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="fas fa-tasks me-2"></i>Quick Actions
                                </h5>
                            </div>
                            <div class="col-auto">
                                <a href="{% url 'core:manager_history' %}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-history me-1"></i>View History
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body py-3">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                                <h6>{{ pending_count }} Expenses</h6>
                                <p class="text-muted mb-0">Awaiting your approval</p>
                            </div>
                            <div class="col-md-4">
                                <i class="fas fa-chart-bar fa-2x text-info mb-2"></i>
                                <h6>{{ total_approvals }} Total</h6>
                                <p class="text-muted mb-0">Reviews completed</p>
                            </div>
                            <div class="col-md-4">
                                <i class="fas fa-percentage fa-2x text-success mb-2"></i>
                                <h6>{{ approved_count|floatformat:0 }}% Approval Rate</h6>
                                <p class="text-muted mb-0">Overall approval rate</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Approvals List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-hourglass-half me-2"></i>Pending Approvals
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        {% if pending_approvals %}
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Employee</th>
                                            <th>Description</th>
                                            <th>Date</th>
                                            <th>Category</th>
                                            <th>Amount</th>
                                            <th>Priority<!-- Priority determined by amount --></th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for approval in pending_approvals %}
                                        <tr class="expense-item priority-{% if approval.expense.amount > 1000 %}high{% elif approval.expense.amount > 500 %}medium{% else %}low{% endif %}">
                                            <td>
                                                <div>
                                                    <strong>{{ approval.expense.employee.name }}</strong>
                                                    <br><small class="text-muted">{{ approval.expense.employee.email }}</small>
                                                </div>
                                            </td>
                                            <td>{{ approval.expense.description|truncatechars:50 }}</td>
                                            <td>{{ approval.expense.date }}</td>
                                            <td>
                                                <span class="badge bg-secondary">{{ approval.expense.category }}</span>
                                            </td>
                                            <td>
                                                <strong>{{ approval.expense.currency }} {{ approval.expense.amount }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge {% if approval.expense.amount > 1000 %}bg-danger{% elif approval.expense.amount > 500 %}bg-warning{% else %}bg-success{% endif %}">
                                                    {% if approval.expense.amount > 1000 %}High{% elif approval.expense.amount > 500 %}Medium{% else %}Low{% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-primary me-1" onclick="viewExpenseForApproval('{{ approval.expense.id }}')">
                                                    <i class="fas fa-eye"></i> Review
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                <h5 class="text-success">All caught up!</h5>
                                <p class="text-muted">No expenses pending your approval.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-clipboard-check me-2"></i>Review Expense
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="approvalModalContent">
                    <!-- Content will be loaded here -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading expense details...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="rejectExpense()">
                        <i class="fas fa-times me-1"></i>Reject
                    </button>
                    <button type="button" class="btn btn-success" onclick="approveExpense()">
                        <i class="fas fa-check me-1"></i>Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Form Modal -->
    <div class="modal fade" id="approvalFormModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="approvalFormTitle">
                        <i class="fas fa-comment me-2"></i>Add Comment
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="approvalForm">
                        <input type="hidden" id="actionType" name="actionType">
                        <div class="mb-3">
                            <label for="remarks" class="form-label">Comments (Optional)</label>
                            <textarea class="form-control" id="remarks" name="remarks" rows="3" placeholder="Add any comments about this decision..."></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            You are about to <strong id="actionText">approve</strong> this expense.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmActionBtn">
                        <i class="fas fa-check me-1"></i>Confirm Action
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="messageToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- Message will be shown here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentExpenseId = null;

        function showToast(message, type = 'info') {
            const toast = document.getElementById('messageToast');
            const toastMessage = document.getElementById('toastMessage');
            const toastHeader = toast.querySelector('.toast-header i');
            
            toastMessage.textContent = message;
            
            toastHeader.className = `fas me-2 ${
                type === 'success' ? 'fa-check-circle text-success' :
                type === 'error' ? 'fa-exclamation-circle text-danger' :
                'fa-info-circle text-primary'
            }`;
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        function viewExpenseForApproval(expenseId) {
            currentExpenseId = expenseId;
            
            // Show loading state
            document.getElementById('approvalModalContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading expense details...</p>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
            modal.show();
            
            // Fetch expense details
            fetch(`{% url "core:expense_approval" 0 %}`.replace('0', expenseId))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const expense = data.expense;
                    const priorityClass = expense.amount > 1000 ? 'danger' : expense.amount > 500 ? 'warning' : 'success';
                    
                    const content = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-user me-1"></i>Employee Details</h6>
                                <p><strong>Name:</strong> ${expense.employee.name}<br>
                                <strong>Email:</strong> ${expense.employee.email}<br>
                                <strong>Department:</strong> ${expense.employee.department}</p>
                                
                                <h6><i class="fas fa-info-circle me-1"></i>Expense Details</h6>
                                <p><strong>Description:</strong> ${expense.description}</p>
                                <p><strong>Date:</strong> ${expense.date}</p>
                                <p><strong>Category:</strong> <span class="badge bg-secondary">${expense.category}</span></p>
                                
                                ${expense.remarks ? `
                                    <h6><i class="fas fa-sticky-note me-1"></i>Remarks</h6>
                                    <p class="text-muted">${expense.remarks}</p>
                                ` : ''}
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-calculator me-1"></i>Amount</h6>
                                <p><strong>Total Amount:</strong> ${expense.currency} ${expense.amount}</p>
                                <span class="badge bg-${priorityClass} mb-3">
                                    Priority: ${expense.amount > 1000 ? 'High' : expense.amount > 500 ? 'Medium' : 'Low'}
                                </span>
                                
                                <h6><i class="fas fa-file-alt me-1"></i>Receipt</h6>
                                <p>${expense.has_receipt ? 
                                    `<a href="${expense.receipt_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download me-1"></i>View Receipt
                                    </a>` : 
                                    '<span class="text-muted">No receipt attached</span>'
                                }</p>
                                
                                <h6><i class="fas fa-history me-1"></i>Created</h6>
                                <p class="text-muted small">${expense.created_at}</p>
                            </div>
                        </div>
                        
                        ${expense.approvals.length > 0 ? `
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6><i class="fas fa-users me-1"></i>Approval Chain</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Approver</th>
                                                    <th>Status</th>
                                                    <th>Date</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${expense.approvals.map(approval => `
                                                    <tr>
                                                        <td>${approval.approver_name} (${approval.approver_email})</td>
                                                        <td>
                                                            <span class="badge ${
                                                                approval.status === 'Approved' ? 'bg-success' :
                                                                approval.status === 'Rejected' ? 'bg-danger' :
                                                                'bg-warning'
                                                            }">${approval.status}</span>
                                                        </td>
                                                        <td>${approval.created_at}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    `;
                    
                    document.getElementById('approvalModalContent').innerHTML = content;
                } else {
                    showToast(data.message, 'error');
                    modal.hide();
                }
            })
            .catch(error => {
                showToast('Error loading expense details.', 'error');
                modal.hide();
            });
        }

        function approveExpense() {
            showApprovalForm('approve');
        }

        function rejectExpense() {
            showApprovalForm('reject');
        }

        function showApprovalForm(action) {
            document.getElementById('actionType').value = action;
            document.getElementById('actionText').textContent = action;
            document.getElementById('approvalFormTitle').innerHTML = `</i>${action.charAt(0).toUpperCase() + action.slice(1)}ing Expense<i class="fas fa-comment me-2">`;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.className = action === 'approve' ? 'btn btn-success' : 'btn btn-danger';
            confirmBtn.innerHTML = `<i class="fas fa-${action === 'approve' ? 'check' : 'times'} me-1"></i>${action.charAt(0).toUpperCase() + action.slice(1)}`;
            
            const formModal = new bootstrap.Modal(document.getElementById('approvalFormModal'));
            formModal.show();
        }

        document.getElementById('confirmActionBtn').addEventListener('click', function() {
            const action = document.getElementById('actionType').value;
            const remarks = document.getElementById('remarks').value;
            
            const data = {
                action: action,
                remarks: remarks
            };

            fetch(`{% url "core:approve_expense" 0 %}`.replace('0', currentExpenseId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('approvalModal')).hide();
                    bootstrap.Modal.getInstance(document.getElementById('approvalFormModal')).hide();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('An error occurred. Please try again.', 'error');
            });
        });
    </script>
</body>
</html>
